<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="586px" preserveAspectRatio="none" style="width:625px;height:586px;" version="1.1" viewBox="0 0 625 586" width="625px" zoomAndPan="magnify"><defs><filter height="300%" id="f1oxfittnv5iqo" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><rect fill="#FFFFFF" filter="url(#f1oxfittnv5iqo)" height="394.3848" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="20" y="96.0986"/><rect fill="#FFFFFF" filter="url(#f1oxfittnv5iqo)" height="373.436" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="144" y="117.0474"/><rect fill="#FFFFFF" filter="url(#f1oxfittnv5iqo)" height="109.8462" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="356" y="174.9448"/><rect fill="#FFFFFF" filter="url(#f1oxfittnv5iqo)" height="118.8462" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="356" y="371.6372"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="25" x2="25" y1="86.0986" y2="499.4834"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="149" x2="149" y1="86.0986" y2="499.4834"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="360.5" x2="360.5" y1="86.0986" y2="499.4834"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="28" x="8" y="83.1318">用户</text><ellipse cx="25" cy="13" fill="#FEFECE" filter="url(#f1oxfittnv5iqo)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M25,21 L25,48 M12,29 L38,29 M25,48 L12,63 M25,48 L38,63 " fill="none" filter="url(#f1oxfittnv5iqo)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="28" x="8" y="511.6152">用户</text><ellipse cx="25" cy="524.582" fill="#FEFECE" filter="url(#f1oxfittnv5iqo)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M25,532.582 L25,559.582 M12,540.582 L38,540.582 M25,559.582 L12,574.582 M25,559.582 L38,574.582 " fill="none" filter="url(#f1oxfittnv5iqo)" style="stroke: #A80036; stroke-width: 2.0;"/><rect fill="#FEFECE" filter="url(#f1oxfittnv5iqo)" height="30.0986" style="stroke: #A80036; stroke-width: 1.5;" width="70" x="112" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="56" x="119" y="71.1318">页面线程</text><rect fill="#FEFECE" filter="url(#f1oxfittnv5iqo)" height="30.0986" style="stroke: #A80036; stroke-width: 1.5;" width="70" x="112" y="498.4834"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="56" x="119" y="518.6152">页面线程</text><rect fill="#FFA500" filter="url(#f1oxfittnv5iqo)" height="30.0986" style="stroke: #A80036; stroke-width: 1.5;" width="129" x="294.5" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="115" x="301.5" y="71.1318">sevice-worker线程</text><rect fill="#FFA500" filter="url(#f1oxfittnv5iqo)" height="30.0986" style="stroke: #A80036; stroke-width: 1.5;" width="129" x="294.5" y="498.4834"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="115" x="301.5" y="518.6152">sevice-worker线程</text><rect fill="#FFFFFF" filter="url(#f1oxfittnv5iqo)" height="394.3848" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="20" y="96.0986"/><rect fill="#FFFFFF" filter="url(#f1oxfittnv5iqo)" height="373.436" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="144" y="117.0474"/><rect fill="#FFFFFF" filter="url(#f1oxfittnv5iqo)" height="109.8462" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="356" y="174.9448"/><rect fill="#FFFFFF" filter="url(#f1oxfittnv5iqo)" height="118.8462" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="356" y="371.6372"/><polygon fill="#A80036" points="132,113.0474,142,117.0474,132,121.0474,136,117.0474" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="30" x2="138" y1="117.0474" y2="117.0474"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="8" x="37" y="112.2925">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="52" x="49" y="112.2925">打开页面</text><polygon fill="#A80036" points="41,141.9961,31,145.9961,41,149.9961,37,145.9961" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="35" x2="143" y1="145.9961" y2="145.9961"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="8" x="47" y="141.2412">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="52" x="59" y="141.2412">页面展示</text><polygon fill="#A80036" points="344,170.9448,354,174.9448,344,178.9448,348,174.9448" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="154" x2="350" y1="174.9448" y2="174.9448"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="8" x="161" y="170.1899">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="173" y="170.1899">异步检查sw是否有更新</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="408" y1="203.8936" y2="203.8936"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="408" x2="408" y1="203.8936" y2="216.8936"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="367" x2="408" y1="216.8936" y2="216.8936"/><polygon fill="#A80036" points="377,212.8936,367,216.8936,377,220.8936,373,216.8936" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="8" x="373" y="199.1387">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="385" y="199.1387">更新sw， 下载预缓存列表中的静态资源</text><path d="M371,229.8936 L371,253.8936 L512,253.8936 L512,239.8936 L502,229.8936 L371,229.8936 " fill="#FBFB77" filter="url(#f1oxfittnv5iqo)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M502,229.8936 L502,239.8936 L512,239.8936 L502,229.8936 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="120" x="377" y="247.0874">新的sw进入等待阶段</text><polygon fill="#A80036" points="165,280.791,155,284.791,165,288.791,161,284.791" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="159" x2="360" y1="284.791" y2="284.791"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="8" x="171" y="280.0361">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="183" y="280.0361">向页面线程发送更新消息</text><polygon fill="#A80036" points="41,309.7397,31,313.7397,41,317.7397,37,313.7397" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="35" x2="143" y1="313.7397" y2="313.7397"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="8" x="47" y="308.9849">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="78" x="59" y="308.9849">更新弹窗提示</text><polygon fill="#A80036" points="132,338.6885,142,342.6885,132,346.6885,136,342.6885" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="30" x2="138" y1="342.6885" y2="342.6885"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="8" x="37" y="337.9336">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="78" x="49" y="337.9336">用户点击更新</text><polygon fill="#A80036" points="344,367.6372,354,371.6372,344,375.6372,348,371.6372" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="154" x2="350" y1="371.6372" y2="371.6372"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="8" x="161" y="366.8823">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="171" x="173" y="366.8823">向sw线程发送skipwaiting命令</text><path d="M159,384.6372 L159,408.6372 L371,408.6372 L371,394.6372 L361,384.6372 L159,384.6372 " fill="#FBFB77" filter="url(#f1oxfittnv5iqo)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M361,384.6372 L361,394.6372 L371,394.6372 L361,384.6372 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="165" y="401.8311">使用MessageChannel来进行通信</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="366" x2="408" y1="439.5347" y2="439.5347"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="408" x2="408" y1="439.5347" y2="452.5347"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="367" x2="408" y1="452.5347" y2="452.5347"/><polygon fill="#A80036" points="377,448.5347,367,452.5347,377,456.5347,373,452.5347" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="8" x="373" y="434.7798">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="211" x="385" y="434.7798">直接跳过等待阶段，新的sw替换旧的</text><polygon fill="#A80036" points="165,477.4834,155,481.4834,165,485.4834,161,481.4834" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="159" x2="355" y1="481.4834" y2="481.4834"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="16" x="171" y="476.7285">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="78" x="191" y="476.7285">重新刷新页面</text><!--
@startuml

autonumber

actor "用户" as User
participant "页面线程" as Browser
participant "sevice-worker线程" as Server #orange

activate User

User -> Browser: 打开页面
activate Browser

Browser -> User: 页面展示

Browser -> Server: 异步检查sw是否有更新
activate Server

Server -> Server: 更新sw， 下载预缓存列表中的静态资源
note right of Server: 新的sw进入等待阶段

Server -> Browser: 向页面线程发送更新消息
deactivate Server

Browser - -> User: 更新弹窗提示

User -> Browser: 用户点击更新

Browser -> Server: 向sw线程发送skipwaiting命令
note right of Browser: 使用MessageChannel来进行通信
activate Server

Server -> Server: 直接跳过等待阶段，新的sw替换旧的

Server -> Browser: 重新刷新页面

@enduml

PlantUML version 1.2019.03(Sun Mar 10 19:04:44 CST 2019)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 1.8.0_161-b14
Operating System: Linux
OS Version: 3.10.0-327.22.2.el7.x86_64
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>
